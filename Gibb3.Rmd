---
title: "Gibb3"
output: html_document
---

```{r}
get_cov = function(h2, n_sib = 0) {
  cov <- matrix(h2/2, 4 + n_sib, 4 + n_sib)
  diag(cov) <- 1
  cov[3,4] <- cov[4,3] <- 0
  cov[1:2, 1] <- cov[1, 1:2] <- h2
  cov
}
```


```{r}
calc_distribution = function(sigma){
  out = list()
  for (i in 1:nrow(sigma)){
    sigma_bar = sigma[i,i] - sigma[i , -i] %*% solve(sigma[-i , -i]) %*% sigma[-i , i]
    mu_mult_bar = sigma[i , -i] %*% solve(sigma[ -i, -i])
    out[[i]] = list('sigma'=sigma_bar, 'mu_mult'=mu_mult_bar)
    }
  return(out)
  }
```

```{r}
s = get_cov(0.5)
print(s)
calc_distribution(s)
```



```{r}
# Vores gibb sampler

set.seed(42)

covmat = get_cov(0.5)

N = 3000
M = 1e5

k = nrow(covmat)

const_list = calc_distribution(covmat)

liabil = matrix(0, nrow = N, ncol = k) # i formen c(l_g, l, l_p1, l_p2)
mu_vec = rep(0, N)



for (i in 1:(N-1)) {
  for (j in 1:k) {
    # Udregner parametre
    sigma = const_list[[j]]$sigma
    mu_mult = const_list[[j]]$mu_mult
    mu = mu_mult %*% liabil[i,-j] # Udelukker den liability vi er kommet til
    #print(liabil)
    liabil[i,j] = rnorm(1, mean = mu, sd = sqrt(sigma))
    
    
    # Hvis liability er l_g variere den frit
    #if (j == 1){
      
     # mu_vec[i] = mu
    #}
    #else{
      # Ellers benytter vi truncation
     # q = runif(1, 0.95, 1)
      #liabil[j] = qnorm(q, mu, sqrt(sigma))
    #}
    
  #print(liabil_star[-j])
  }
  liabil[i+1,] = liabil[i,]
}

```
```{r}
liabil[1,]
```


```{r}
plot(liabil[,1], type='l')
```
```{r}
cov(liabil)
```

