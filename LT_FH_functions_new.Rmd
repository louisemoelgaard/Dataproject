---
title: "LT_FH"
output: html_document
---
```{r}
library(bigsnpr)
library(dplyr)
```

```{r}
get_cov = function(h2, n_sib = 0) {
  cov <- matrix(h2/2, 4 + n_sib, 4 + n_sib)
  diag(cov) <- 1
  cov[3,4] <- cov[4,3] <- 0
  cov[1:2, 1] <- cov[1, 1:2] <- h2
  cov
}
```

```{r}
calc_distribution = function(sigma){
  out = list()
  for (i in 1:nrow(sigma)){
    mu_mult_bar = solve(sigma[ -i, -i], sigma[i , -i])
    sigma_bar = sigma[i,i] - mu_mult_bar %*% sigma[-i , i]
    out[[i]] = list('sigma'=sigma_bar, 'mu_mult'=mu_mult_bar)
    }
  return(out)
  }
```


```{r}
# Vores gibbssampler


Gibbs <- function(covmat, phenos, N=10000, K = 0.05, s_val = 0){

  
  k = nrow(covmat)

  const_list = calc_distribution(covmat)
  
  liabil = matrix(s_val, nrow = N, ncol = k) # i formen c(l_g, l, l_p1, l_p2)
  
  current_liabil = rep(s_val, k)
  
  start_run = 500
  s = 0
  p = 0
  
  while(TRUE) {
    p = p +1
  for (i in 2:start_run) {
    s = s + 1
    for (j in 1:k) {
      # Udregner parametre
      sigma = const_list[[j]]$sigma
      mu_mult_ = const_list[[j]]$mu_mult
      mu = mu_mult_ %*% current_liabil[-j] # Udelukker den liability vi er kommet til
    
      
      if (j == 1) {
        current_liabil[j] = rnorm(1, mu, sqrt(sigma))
      }
      else {
        crit <- qnorm(1-K)
        crit_bound = pnorm(crit, mu, sqrt(sigma))
        
        interval_2 = c(0, crit_bound)
        interval_1 = c(crit_bound, 1)
        
        phen = phenos[j-1]
        interval = phen * interval_1 + (1-phen)*interval_2
        U = runif(1,interval[1], interval[2])
        current_liabil[j] = qnorm(U, mu, sqrt(sigma))
      }
      
    
    if(s > start_run){
      liabil[i+start_run*(p-2),] = current_liabil
    }
    }
  }

  if(s>start_run){
      end_val = s-start_run
      if(sd(liabil[1:end_val,1])/sqrt(length(liabil[1:end_val,1])) < 0.1){
        return(colMeans(liabil[1:end_val,]))
      }
  }
      
  
  #return(list('liabilities'=liabil, 'mu'=mu_vec))
  }
}
  
```


```{r}
covmat = get_cov(0.5)
Gibbs(covmat, c(0,0,1))
```


```{r}
Gibbs_notrunc <- function(covmat, N=3000, K = 0.05, s_val = 0){

  k = nrow(covmat)

  const_list = calc_distribution(covmat)

  liabil = matrix(s_val, nrow = N, ncol = k) # i formen c(l_g, l, l_p1, l_p2)
  mu_vec = matrix(s_val, nrow = N-1, ncol = k)
  current_liabil = rep(s_val, k)

  for (i in 1:(N)) {
    for (j in 1:k) {
      # Udregner parametre
      sigma = const_list[[j]]$sigma
      mu_mult = const_list[[j]]$mu_mult
      mu = mu_mult %*% current_liabil[-j] # Udelukker den liability vi er kommet til
      mu_vec[i,j] = mu
      current_liabil[j] = rnorm(1, mu, sqrt(sigma))
    }
    liabil[i,] = current_liabil
  }
  
  
  return(list('liabilities'=liabil, 'mu'=mu_vec))
}
```



```{r}
Assign_LT_FH = function(phen_file){

  
  
}
```

```{r}
 estimate_conf = function(unique_comb, n_sib=0, h2=0.5){
   covmat = get_cov(h2, n_sib)
   estimates = matrix(NA, nrow = nrow(unique_comb), ncol=4+n_sib)
    for (i in 1:nrow(unique_comb)){
      estimates[i,] = Gibbs(covmat, unique_comb[i,])
    } 
   
   return(cbind(unique_comb, estimates))
 }

```


```{r}
Calc_phen = function(fam, K=0.05, n_sib=0, h2=0.5){
  T_ = qnorm(1-K)
  N = nrow(fam)
  k = 3+n_sib
  l_gs = matrix(0, nrow=N, ncol=k*2)
  for (i in 1:k){
    l_gs[,i] = (fam[[i*2]] + fam[[i*2+1]])
    l_gs[,i+k] = (fam[[i*2]] + fam[[i*2+1]]) >=T_
  }
  unique_comb = unique(l_gs[,-c(1:3+n_sib)])
  return(unique_comb)
}

```

```{r}
G = snp_attach("test_parent.rds")

fam = G$fam

temp = Calc_phen(G$fam)



estimate_conf(temp)

```




