---
title: "Gibb2"
output: html_document
---



```{r}
h_sq = 0.5

covmat = c(1-h_sq, 0,        0,        0,
           0,      h_sq,     1/2*h_sq, 1/2*h_sq,
           0,      1/2*h_sq, 1,        0,
           0,      1/2*h_sq, 0,        1)


covmat = matrix(covmat, ncol=4, nrow=4)


mult_mat_l_g = c(0,1,0,0,
                 1,1,0,0,
                 0,0,1,0,
                 0,0,0,1)

mult_mat_l = c(1,1,0,0,
               0,1,0,0,
               0,0,1,0,
               0,0,0,1)

mult_mat_l = c(1,0,0,0,
               0,1,0,0,
               0,0,1,0,
               0,0,0,1)

mult_mat_l_p1 = c(0,0,1,0,
                  0,1,0,0,
                  1,1,0,0,
                  0,0,0,1)

mult_mat_l_p2 = c(0,0,0,1,
                  0,1,0,0,
                  1,1,0,0,
                  0,0,1,0)

names = list('l_g', 'l', 'l_p1', 'l_p2')
mult_mat = list('l_g'=matrix(mult_mat_l_g, ncol=4, nrow=4), 
                'l'=matrix(mult_mat_l, ncol=4, nrow=4), 
                'l_p1'=matrix(mult_mat_l_p1, ncol=4, nrow=4),
                'l_p2'=matrix(mult_mat_l_p2, ncol=4, nrow=4))

```


```{r}
calc_distribution = function(sigma){
  n = nrow(sigma)
  sigma_bar = sigma[1,1] - sigma[1 , 2:n] %*% solve(sigma[2:n , 2:n]) %*% sigma[2:n , 1]
  mu_mult_bar = sigma[1 , 2:n] %*% solve(sigma[2:n , 2:n])
  return(list('sigma'=sigma_bar, 'mu_mult'=mu_mult_bar))
  }
```




```{r}
k = nrow(covmat)
const_list = list(rep(0, k))
i=0

for (mat in mult_mat){
  i= i+1
  alg = mat %*% covmat %*% t(mat)
  const = calc_distribution(alg)
  const_list[[i]] = const
  
}

```


```{r}
N = 3000
M = 1e5
```


```{r}
liabil = c(0,0,0,0)
mu_vec = rep(0, N)

for (i in 1:N) {
  for (j in 1:k) {
    
    sigma = const_list[[j]][[1]]
    mu_mult = const_list[[j]][[2]]
    mu = mu_mult %*% liabil[-j]
    
    if (j != 1){
      q = runif(1, 0.95, 1)
      liabil[j] = qnorm(q, mu, sigma)
    }
    else{
      liabil[j] = rnorm(1, mu, sigma)
      mu_vec[i] = mu
    }
    

  }
}
```


```{r}
liabil
```

```{r}
plot(mu_vec, type='l')
```
